/**
 * Created by RMA on 3/25/2020.
 */

transaction = (function () {
    "use strict";

    var formId = $('#bankDeposit');

    function _baseURL() {
        return nesGlobal.baseURL;
    }

    function save() {
        $(formId).on('click', '#btnSave', function () {
            $(formId).validate({
                submitHandler: function (form) {
                    var data = new FormData($(form)[0]);
                    data.append('uploadFile', $('input[type=file]')[0].files[0]);
                    $.ajax({
                        url: _baseURL() + 'save',
                        type: 'POST',
                        data: data,
                        enctype: 'multipart/form-data',
                        contentType: false,
                        processData: false,
                        success: function (res) {
                            if (res.status == 1) {
                                successMsg(res.text, _baseURL());
                            } else {
                                warningMsg(res.text);
                            }
                        }
                    });
                }
            });
        })
    }

    function getTotalCardsBankWIse(){
        $.ajax({
            url: _baseURL() + 'getTotalCardsBankWise',
            type: 'GET',
            success: function (res) {
                var row = "";
                var usdCards = 0;
                var inrCards = 0;

                var usdAmt = 0;
                var inrAmt = 0;
                for (var i in res){
                    row = row + '<tr>'+
                        // '<td>' + (parseInt(i)+1) + '</td>' +
                        '<td>' + (res[i].bank) + '</td>' +
                        '<td>' + (res[i].cardType) + '</td>' +
                        '<td>' + (res[i].usd_num) + '</td>' +
                        '<td>' + (res[i].inr_num) + '</td>' +
                        '<td class="text-right">' + (commaSeparator(res[i].usd_amt)) + '</td>' +
                        '<td class="text-right">' + (commaSeparator(res[i].inr_amt)) + '</td>' +
                        '</tr>'
                    usdCards += res[i].usd_num;
                    inrCards += res[i].inr_num;
                    usdAmt += res[i].usd_amt;
                    inrAmt += res[i].inr_amt;

                }
                row = row + '<tr>'+
                    '<th class="text-center" colspan="2" scope="row">TOTAL</th>' +
                    '<th>' + usdCards + '</th>' +
                    '<th>' + inrCards + '</th>' +
                    '<th class="text-right">' + commaSeparator( usdAmt ) + '</th>' +
                    '<th class="text-right">' + commaSeparator( inrAmt ) + '</th>' +
                    '</tr>'

                var cardTable = $('#cardInfo');
                cardTable.find('tbody').empty().prepend(row);
            }
        });
    }

    function getAllCardInfoList(){
        $.ajax({
            url: _baseURL() + 'getAllCardInfoList',
            type: 'GET',
            success: function (res) {
                var row = "";
                for (var i in res){
                    row = row + '<tr>'+
                        '<td>' + (parseInt(i)+1) + '</td>' +
                        '<td>' + (res[i].cid) + '</td>' +
                        '<td>' + (res[i].name) + '</td>' +
                        '<td>' + (res[i].cardType) + '</td>' +
                        '<td class="text-right">' + (commaSeparator(res[i].sanctionAmt)) + '</td>' +
                        '<td>' + (res[i].currency) + '</td>' +
                        '<td>' + (res[i].bank) + '</td>' +
                        '</tr>'
                }

                var tableID = $('#allCardInfoTable');
                tableID.dataTable().fnDestroy();
                tableID.find('tbody').empty().prepend(row);
                createDataTableWithButtons(tableID);
            }
        });
    }

    return {
        save: save,
        getTotalCardsBankWIse: getTotalCardsBankWIse,
        getAllCardInfoList: getAllCardInfoList
    };
})();

$(document).ready(function () {
    transaction.save();
    transaction.getTotalCardsBankWIse();
    transaction.getAllCardInfoList();
});